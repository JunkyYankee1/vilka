# Поиск по меню

## Обзор

Система поиска по меню реализует высококачественный поиск с поддержкой русского языка, толерантностью к опечаткам, синонимами и умной автоматической навигацией. Поиск работает на основе токенизации запросов и блюд, гибридного скоринга и кэширования индекса.

## Архитектура

### API Endpoint

**`GET /api/search?q=<query>&limit=<limit>&debug=true`**

- **`q`** (обязательно): Поисковый запрос
- **`limit`** (опционально): Максимум результатов (1-10, по умолчанию: 10)
- **`debug`** (опционально): Включить отладочное логирование (только в development)

**Ответ:**
```json
{
  "results": [
    {
      "id": 1,
      "name": "Бизнес-ланч",
      "description": "Сытный обед",
      "price": 450,
      "discount_percent": null,
      "image_url": null,
      "category_name": "Горячие блюда",
      "subcategory_name": "Ланчи",
      "score": 20,
      "match_type": "exact"
    }
  ],
  "count": 1,
  "query": "бизнес ланч",
  "shouldAutoNavigate": true,
  "hint": null
}
```

### Индексирование

**Файл**: `src/lib/search/indexCache.ts`

- **Кэш в памяти** с TTL 5 минут
- **Автоматическая пересборка** при изменении данных меню
- **Логирование производительности** в dev режиме (время сборки, cache hit/miss)

**Производительность:**
- Первый запрос (cache miss): ~50-100ms
- Кэшированные запросы: ~10-30ms
- Сборка индекса: ~5-20ms (только при cache miss)

### Кэширование на клиенте

**Файл**: `src/app/_components/CatalogPageClient.tsx`

- **Кэш в памяти** с TTL 45 секунд
- **Ключ кэша**: нормализованный запрос (lowercase)
- **Очистка**: Хранит только последние 50 запросов
- **Результат**: Повторные запросы возвращаются мгновенно без сетевых запросов

## Нормализация

**Файл**: `src/lib/search/normalizeRu.ts`

### Правила нормализации

1. **Приведение к нижнему регистру**
2. **Удаление пробелов** в начале и конце
3. **Замена "ё" → "е"** (для русского языка)
4. **Маппинг латинских букв на кириллицу**:
   - `a` → `а`, `e` → `е`, `o` → `о`, `p` → `р`, `c` → `с`, `x` → `х`
   - `y` → `у`, `k` → `к`, `m` → `м`, `t` → `т`, `b` → `в`, `h` → `н`
5. **Обработка разделителей**: `-`, `—`, `_`, `/`, `.`, `,`, `:`, `;`, `(`, `)`, `[`, `]`, `{`, `}`, `'`, `"` → пробелы
6. **Удаление пунктуации** (кроме букв, цифр и пробелов)
7. **Схлопывание множественных пробелов** в один

**Примеры:**
- "кофe" (латинская e) → "кофе" (кириллическая е)
- "салaт" (латинская a) → "салат" (кириллическая а)
- "бизнес-ланч" → "бизнес ланч"
- "кофе   и   чай" → "кофе и чай"

### Токенизация

**Функция**: `tokenizeRu(text: string): string[]`

- Разбивает нормализованный текст на токены по пробелам
- Фильтрует очень короткие токены (длина < 2), кроме цифр
- Возвращает массив нормализованных токенов

**Примеры:**
- "бизнес-ланч" → ["бизнес", "ланч"]
- "кофе и чай" → ["кофе", "и", "чай"]

## Морфология (Стемминг)

**Файл**: `src/lib/search/morphology.ts`

### Консервативный стемминг

- **Применяется только к токенам длиной >= 5 символов**
- **Удаляет общие окончания русских прилагательных**:
  - "куриный" → "курин"
  - "куриная" → "курин"
  - "куриное" → "курин"
  - "куриные" → "курин"
- **Возвращает оригинал**, если окончание не найдено или токен слишком короткий

**Результат**: "куриный" теперь находит "куриная", "куриное", "куриные" блюда.

## Сопоставление и скоринг

**Файл**: `src/lib/search/menuSearch.ts`

### Типы совпадений

1. **Точное совпадение токена** (score: 10)
   - Запрос "бизнес" точно совпадает с токеном "бизнес" в названии

2. **Префиксное совпадение токена** (score: 6)
   - Запрос "биз" совпадает с началом токена "бизнес"

3. **Подстрока токена** (score: 3)
   - Запрос "лан" найден внутри токена "ланч"

4. **Опечатка (Damerau-Levenshtein)** (score: 4)
   - Токены 4-8 символов: расстояние ≤ 1
   - Токены > 8 символов: расстояние ≤ 2
   - Токены < 4 символов: опечатки не учитываются

5. **Триграммное сходство** (score: similarity × 4)
   - Fallback для нечеткого поиска
   - Порог сходства: > 0.3

### Веса полей

- **Название**: × 1.0 (полный вес)
- **Категория**: × 0.6
- **Описание**: × 0.3

### Пороги

- **MIN_QUERY_LENGTH**: 2 (абсолютный минимум для поиска)
- **MIN_QUERY_LENGTH_FOR_RESULTS**: 3 (показывать подсказку, если < 3)
- **MIN_QUERY_LENGTH_FOR_FUZZY**: 4 (включить опечатки/триграммы)
- **MIN_SCORE**: 6 (фильтровать низкокачественные результаты)
- **AUTO_OPEN_MIN_SCORE**: 8 (минимум для автоматической навигации)
- **AUTO_OPEN_MIN_QUERY_LENGTH**: 4 (минимум длины запроса для авто-навигации)

### Примеры скоринга

**Запрос**: "бизнес ланч" против "Бизнес-ланч"
- "бизнес" точное совпадение в названии: 10 × 1.0 = 10
- "ланч" точное совпадение в названии: 10 × 1.0 = 10
- **Итоговый score**: 20

**Запрос**: "бизес" (опечатка) против "Бизнес-ланч"
- "бизес" опечатка (расстояние 1) в названии: 4 × 1.0 = 4
- **Итоговый score**: 4 (ниже MIN_SCORE, но все равно совпадает через fallback)

## Синонимы и мягкие расширения

**Файл**: `src/lib/search/synonyms.ts`

### Истинные синонимы (TRUE_SYNONYMS)

**Вес**: 100% (такой же, как оригинальный токен)

**Примеры:**
- "шаверма" ↔ "шаурма" (региональный вариант)
- "питца" → "пицца" (опечатка)
- "супчик" → "суп" (уменьшительная форма)
- "wok" → "вок" (транслитерация)
- "дессерт" → "десерт" (опечатка)

### Мягкие расширения (SOFT_EXPANSIONS)

**Вес**: 30% (намного ниже, чтобы точные совпадения ранжировались выше)

**Назначение**: Категорийные совпадения (шире, чем точное совпадение)

**Примеры:**
- "капучино" → "кофе" (капучино - это тип кофе)

**Логика использования:**
1. Сначала пробуем точные/префиксные совпадения с оригинальным токеном (без мягких расширений)
2. Если найдено точное/префиксное совпадение, мягкие расширения не используются
3. Мягкие расширения используются только как fallback, если нет точного/префиксного совпадения

**Результат:**
- Запрос "капучино" → "Капучино" ранжируется первым (точное совпадение, score 10+)
- Другие кофейные напитки ранжируются ниже (мягкое расширение, score ~3)
- Точные совпадения никогда не переопределяются мягкими расширениями

### Двухпроходное сопоставление

1. **Первый проход**: Пробуем точные/префиксные совпадения с оригинальным токеном (без синонимов)
2. **Второй проход**: Если нет точного/префиксного совпадения, пробуем с расширением синонимов (включая мягкие)

## UX Правила

**Файл**: `src/app/_components/CatalogPageClient.tsx`

### Автоматическая навигация

Автоматическая навигация происходит **ТОЛЬКО** когда:

1. **Ровно 1 результат**: `results.length === 1`
2. **Длина запроса ≥ 4**: `query.length >= AUTO_OPEN_MIN_QUERY_LENGTH`
3. **Score ≥ 8**: `match.score >= AUTO_OPEN_MIN_SCORE`

**Важно**: Если есть 2+ результатов, автоматическая навигация **отключена** независимо от score. Пользователь должен выбрать из выпадающего списка.

### Обработка коротких запросов

- **Длина < 3**: Показывать подсказку "Введите минимум 3 символа для поиска", возвращать пустые результаты
- **Длина == 3**: Разрешить только точные/префиксные совпадения (без опечаток/триграмм)
- **Длина >= 4**: Полная толерантность к опечаткам и триграммное сопоставление

### Клавиатурная навигация

**Файл**: `src/components/SearchResults.tsx`

- **ArrowUp/Down**: Навигация по результатам
- **Enter**: Открыть выбранный элемент
- **Esc**: Закрыть список результатов
- **Визуальная обратная связь**: Выбранный элемент подсвечивается

### Debounce и отмена запросов

- **Debounce**: 400ms (задержка перед отправкой запроса)
- **AbortController**: Отменяет предыдущие запросы при новом нажатии клавиши
- **Обработка AbortError**: Graceful handling без спама в консоли

### Закрытие выпадающего списка

- **Клик вне области**: Закрывает выпадающий список
- **Изменение маршрута**: Закрывает список при выборе элемента (изменение маршрута)
- **Data-атрибуты**: `data-search-input` и `data-search-results` для обнаружения кликов

### Подсветка совпадений

**Файл**: `src/components/SearchResults.tsx`

- **Сохраняет оригинальный регистр**: Подсветка использует оригинальный текст, не нормализованный
- **Безопасное сопоставление**: Поиск без учета регистра, но оригинальный текст в выводе
- **Токен-ориентированная**: Подсветка всех совпавших токенов, не только первого совпадения
- **Обработка перекрытий**: Правильно объединяет перекрывающиеся совпадения

## Производительность

### Кэш индекса

- **TTL**: 5 минут
- **Размер**: Один индекс на все меню
- **Инвалидация**: При изменении данных меню (в будущем)

### Кэш на клиенте

- **TTL**: 45 секунд
- **Размер**: Максимум 50 запросов
- **Ключ**: Нормализованный запрос (lowercase)

### Метрики производительности

В dev режиме API логирует:
```
[search] Performance: {
  query: "бизнес ланч",
  dbTime: "15ms",
  indexBuildTime: "2ms",
  indexFromCache: true,
  searchTime: "3ms",
  totalTime: "20ms"
}
```

**Типичная производительность:**
- Первый запрос (cache miss): ~50-100ms
- Кэшированные запросы: ~10-30ms
- Сборка индекса: ~5-20ms (только при cache miss)

## Тестирование

### Unit-тесты

**Расположение**: `src/lib/search/__tests__/`

1. **`normalizeRu.test.ts`**
   - Тесты нормализации латинских букв
   - Тесты смешанного латинского/кириллического текста
   - Тесты токенизации с латинскими буквами

2. **`menuSearch.test.ts`**
   - Тесты всех сценариев поиска
   - Тесты толерантности к опечаткам
   - Тесты логики автоматической навигации

3. **`synonyms.test.ts`**
   - Тесты расширения синонимов
   - Тесты мягких расширений
   - Тесты `isSoftExpansion()`

4. **`morphology.test.ts`**
   - Тесты стемминга (куриный/куриная/куриное → курин)
   - Тесты, что короткие токены не стеммятся
   - Тесты нечувствительности к регистру

5. **`searchPrecision.test.ts`**
   - Запрос "капучино" → топ-результат "Капучино"
   - Запрос "капучино" → "Капучино" ранжируется выше общих кофейных напитков
   - Запрос "кофе" → возвращает кофейные напитки
   - Запрос "кофe" (латинская e) → ведет себя как "кофе"
   - Мягкие расширения имеют более низкие score, чем точные совпадения

6. **`normalize.test.ts`**
   - Тесты базовой нормализации

### Запуск тестов

```bash
# Все тесты
npm test

# Только тесты поиска
npm test -- search

# Конкретный файл
npm test -- normalizeRu.test.ts
```

### Ручные тестовые случаи

1. **Токен-ориентированное сопоставление**:
   - ✅ "бизнес" → находит "Бизнес-ланч" (префиксное совпадение)
   - ✅ "ланч" → находит "Бизнес-ланч" (совпадение второго слова)
   - ✅ "бизнес ланч" → находит "Бизнес-ланч" (лучший ранг, высокий score)

2. **Толерантность к опечаткам**:
   - ✅ "бизес" (опечатка) → находит "Бизнес-ланч" (если длина >= 4)
   - ✅ "лан" (короткий) → находит, но НЕ через сопоставление опечаток

3. **Автоматическая навигация**:
   - ✅ "бизнес-ланч" (точное, 1 результат) → автоматическая навигация
   - ✅ "вок" (2+ результатов) → показывает список, БЕЗ автоматической навигации
   - ✅ "лан" (короткий запрос) → показывает список, БЕЗ автоматической навигации

4. **Синонимы**:
   - ✅ "шаверма" → находит "шаурма" элементы
   - ✅ "питца" → находит "пицца" элементы

5. **Морфология**:
   - ✅ "куриный" → находит "куриная", "куриное", "куриные" блюда

6. **Латинские буквы**:
   - ✅ "кофe" (латинская e) → ведет себя как "кофе"
   - ✅ "салaт" (латинская a) → ведет себя как "салат"

## Отладка

### Режим отладки

Добавьте `&debug=true` к URL запроса:
```
/api/search?q=вок&debug=true
```

**Вывод в консоли (dev режим):**
```json
{
  "debug": {
    "topScores": [20, 15, 12],
    "matches": [
      {
        "name": "Острый вок с креветкой",
        "score": 20,
        "matchType": "exact",
        "matchedTokens": ["вок"]
      }
    ]
  }
}
```

### Логирование производительности

В dev режиме API логирует:
- Время запроса к БД (`dbTime`)
- Время сборки индекса (`indexBuildTime`)
- Использование кэша (`indexFromCache`)
- Время поиска (`searchTime`)
- Общее время (`totalTime`)

### Типичные проблемы

1. **Результаты не появляются**
   - Проверьте, что запрос нормализован правильно (консоль браузера)
   - Проверьте, что индекс построен (логи в dev режиме)
   - Проверьте score результатов (должен быть >= MIN_SCORE = 6)

2. **Автоматическая навигация не работает**
   - Проверьте, что `results.length === 1`
   - Проверьте, что `query.length >= 4`
   - Проверьте, что `match.score >= 8`

3. **Синонимы не работают**
   - Проверьте, что синоним добавлен в `synonyms.ts`
   - Проверьте, что запрос нормализован (латинские буквы → кириллица)

4. **Медленный поиск**
   - Проверьте, что кэш индекса работает (`indexFromCache: true`)
   - Проверьте, что кэш на клиенте работает (повторные запросы мгновенные)

## Файлы

### Основные файлы

- **`src/app/api/search/route.ts`** - API endpoint поиска
- **`src/lib/search/normalizeRu.ts`** - Нормализация и токенизация
- **`src/lib/search/menuSearch.ts`** - Алгоритм поиска и скоринг
- **`src/lib/search/indexCache.ts`** - Кэширование индекса
- **`src/lib/search/synonyms.ts`** - Словарь синонимов
- **`src/lib/search/morphology.ts`** - Стемминг русских слов
- **`src/lib/search/editDistance.ts`** - Расстояние Damerau-Levenshtein

### UI компоненты

- **`src/components/SearchResults.tsx`** - UI результатов поиска
- **`src/app/_components/CatalogPageClient.tsx`** - Интеграция поиска в каталог

### Тесты

- **`src/lib/search/__tests__/`** - Все unit-тесты поиска

## Резюме

Система поиска обеспечивает:

- ✅ **Точность**: Точные совпадения всегда ранжируются выше
- ✅ **Гибкость**: Толерантность к опечаткам, синонимы, морфология
- ✅ **Производительность**: Кэширование индекса и клиентский кэш
- ✅ **UX**: Умная автоматическая навигация, клавиатурная навигация, подсветка совпадений
- ✅ **Качество**: Стабильное ранжирование, обработка коротких запросов, отладка

Поиск готов к продакшену с улучшенным качеством, производительностью и пользовательским опытом.

